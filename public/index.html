<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de Contratos</title>
  <link rel="stylesheet" href="/estilos.css" />
  <link rel="icon" href="/logo.png" />
</head>
<body>

  <!-- ENCABEZADO -->
  <div style="background:#fff;padding:1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #ccc;">
    <div style="display:flex;align-items:center;">
      <img src="/logo.png" alt="Logo Rai Trai" style="height:60px;margin-right:1rem;">
      <div>
        <h2 style="margin:0;font-size:1.5rem;color:#2c3e50;">GENERADOR AUTOM√ÅTICO DE CONTRATOS</h2>
        <p style="margin:0;font-size:0.9rem;"><strong>Plantilla fija en servidor</strong></p>
      </div>
    </div>
  </div>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="contenedor">

    <!-- 1) SELECCI√ìN DE GRUPO -->
    <h2>Seleccionar Grupo</h2>
    <label>
      N√∫mero de Negocio:
      <input list="businessList" id="numeroNegocio" placeholder="Buscar..." />
    </label>
    <datalist id="businessList"></datalist>

    <label>
      Nombre de Grupo:
      <input list="grupoList" id="nombreGrupo" placeholder="Buscar..." />
    </label>
    <datalist id="grupoList"></datalist>

    <!-- 2) DATOS DEL CONTRATO -->
    <h2>Datos del Contrato</h2>
    <div class="grid">
      <label>Fecha del Contrato:<input type="date" id="FECHA_CONTRATO" /></label>
      <label>Curso:<input type="text" id="CURSO" placeholder="Ej. 3B" /></label>
      <label>A√±o:<input type="number" id="A√ëO" placeholder="Ej. 2025" /></label>
      <label>Colegio:<input type="text" id="COLEGIO" placeholder="Nombre del colegio" /></label>
      <label>Comuna:<input type="text" id="COMUNA" placeholder="Ej. Providencia" /></label>
      <label>Valor Programa:<input type="text" id="VALOR_PROGRAMA" placeholder="Ej. 1200" /></label>
      <label>PAX M√≠nimos:<input type="number" id="PAX_MIN" placeholder="Ej. 20" /></label>
      <label>PAX Liberados:<input type="number" id="PAX_LIBERADOS" placeholder="Ej. 2" /></label>

      <label>Email destinatario:
        <input list="emailList" id="DEST_EMAIL" placeholder="Selecciona un email" />
      </label>
      <datalist id="emailList">
        <option value="nachopastorpino@gmail.com">
        <option value="griveros@raitrai.cl">
        <option value="cgayoso@raitrai.cl">
        <option value="crojas@raitrai.cl">
        <option value="orietta@raitrai.cl">
        <option value="elagos@raitrai.cl">
        <option value="aflores@raitrai.cl">
        <option value="chernandez@raitrai.cl">
      </datalist>

      <label>Moneda:
        <select id="MONEDA">
          <option value="">Selecciona moneda</option>
          <option value="$USD">$USD</option>
          <option value="$CLP">$CLP</option>
        </select>
      </label>
      <label>Cuota Inscripci√≥n:<input type="text" id="CUOTA_INSCRIPCION" placeholder="Ej. 150" /></label>
      <label>Fecha Inscripci√≥n:<input type="date" id="FECHA_INSCRIPCION" /></label>
      <label>Fecha Pago Final:<input type="date" id="FECHA_PAGO_FINAL" /></label>

      <!-- CAMPOS ADICIONALES -->
      <label>N√∫mero de Cuotas:<input type="number" id="NUM_CUOTAS" /></label>
      <label>Valor de Cuota Mensual:<input type="text" id="MONEDA_CUOTA_MENSUAL" /></label>
      <label>Mes Inicio Pago:<input type="text" id="MES_INICIO_PAGO" /></label>
      <label>A√±o Inicio Pago:<input type="number" id="ANO_INICIO_PAGO" /></label>
      <label>Mes Fin Pago:<input type="text" id="MES_FIN_PAGO" /></label>
      <label>A√±o Fin Pago:<input type="number" id="ANO_FIN_PAGO" /></label>
      <label>D√≠a de Pago Mensual:<input type="number" id="DIA_PAGO_MENSUAL" /></label>
      <label>Fecha √öltima Cuota:<input type="date" id="FECHA_ULTIMA_CUOTA" /></label>
      <label>Fecha Corte Contrato:<input type="date" id="FECHA_CORTE_CONTRATO" /></label>
      <label>Mes del Viaje:<input type="text" id="MES_VIAJE" /></label>
      <label>Lugar de Salida:<input type="text" id="LUGAR_SALIDA" /></label>
    </div>

    <!-- 3) CL√ÅUSULAS ADICIONALES -->
    <h2>Cl√°usulas adicionales</h2>
    <div id="clausulasContainer"></div>
    <button id="addClause" style="margin-bottom:1rem;">‚ûï Agregar cl√°usula</button>

    <!-- 4) GENERAR -->
    <button onclick="generarContrato()">üìÑ Descargar Contrato</button>
    <div id="estado" style="margin-top:1rem;font-style:italic;color:#c0392b;"></div>
  </div>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/AKfycbzU3RIF2TXDhlUwuSZj9VFnEienz0_XPw1mVwqzj6TWL3afs4GE-9kFkaRy9ps5YSqFaQ/exec';

    document.getElementById("addClause").addEventListener("click", () => {
      const cont = document.getElementById("clausulasContainer");
      const w = document.createElement("div");
      w.className = "clausula";
      w.style.marginBottom = "1rem";
      w.innerHTML = `
        <label>T√≠tulo cl√°usula:<input type="text" name="titulo" placeholder="Ej: Fuerza mayor"/></label>
        <label>Texto cl√°usula:<textarea name="texto" rows="4" placeholder="Redacta la cl√°usula‚Ä¶"></textarea></label>
        <button type="button" class="removeClause" style="background:#c0392b;color:#fff;">Eliminar</button>
      `;
      cont.appendChild(w);
      w.querySelector(".removeClause").onclick = () => w.remove();
    });

    window.addEventListener("DOMContentLoaded", () => {
      fetch(sheetURL)
        .then(r => {
          if (!r.ok) throw new Error("HTTP "+r.status);
          return r.json();
        })
        .then(rows => {
          const bl = document.getElementById("businessList");
          const gl = document.getElementById("grupoList");
          rows.forEach(r => {
            if (r.numeroNegocio) bl.append(new Option(r.numeroNegocio, r.numeroNegocio));
            if (r.nombreGrupo)  gl.append(new Option(r.nombreGrupo,  r.nombreGrupo));
          });

          ["numeroNegocio","nombreGrupo"].forEach(id => {
            document.getElementById(id).addEventListener("change", e => {
              const v = e.target.value.trim();
              const row = rows.find(r =>
                String(r.numeroNegocio) === v || r.nombreGrupo === v
              );
              if (!row) return;

              const m = row.nombreGrupo.match(/^(.+?)\s*(?:\(\d{4}\))?(?:\s*-\s*)?(\d+\w?)\s*\((\d{4})\)/);
              if (m) {
                document.getElementById("COLEGIO").value = m[1];
                document.getElementById("CURSO").value   = m[2];
                document.getElementById("A√ëO").value     = m[3];
              }

              document.getElementById("COMUNA").value        = row.direccion || "";
              document.getElementById("VALOR_PROGRAMA").value = String(row.valorPrograma || "").replace(/[^\d]/g,"");
              document.getElementById("PAX_MIN").value       = row.cantidadgrupo || "";
              document.getElementById("PAX_LIBERADOS").value = row.liberados || "";
            });
          });
        })
        .catch(err => {
          console.error("‚ùå Error leyendo Sheet JSON:", err);
          document.getElementById("estado").textContent = "‚ùå No fue posible cargar los datos.";
        });
    });
    
    async function generarContrato() {
      const campos = [
        'numeroNegocio',
        'FECHA_CONTRATO','CURSO','A√ëO','COLEGIO','COMUNA',
        'VALOR_PROGRAMA','PAX_MIN','PAX_LIBERADOS',
        'DEST_EMAIL','MONEDA','CUOTA_INSCRIPCION',
        'FECHA_INSCRIPCION','FECHA_PAGO_FINAL',
        'NUM_CUOTAS','MONEDA_CUOTA_MENSUAL','MES_INICIO_PAGO','ANO_INICIO_PAGO',
        'MES_FIN_PAGO','ANO_FIN_PAGO','DIA_PAGO_MENSUAL','FECHA_ULTIMA_CUOTA',
        'FECHA_CORTE_CONTRATO','MES_VIAJE','LUGAR_SALIDA'
      ];
    
      const data = {};
      campos.forEach(id => data[id] = document.getElementById(id)?.value || "");
    
      // Alias para reemplazos m√∫ltiples en Word
      data.A√ëO1 = data.A√ëO;
      data.MONEDA1 = data.MONEDA;
      data.MONEDA2 = data.MONEDA;
      data.MONEDA3 = data.MONEDA;
      data.MONEDA4 = data.MONEDA;
      data.MONEDA5 = data.MONEDA;
      data.VALOR_PROGRAMA1 = data.VALOR_PROGRAMA;
      data.CUOTA_INSCRIPCION1 = data.CUOTA_INSCRIPCION;
      data.CUOTA_INSCRIPCION2 = data.CUOTA_INSCRIPCION;
      data.CUOTA_INSCRIPCION3 = data.CUOTA_INSCRIPCION;
      data.FECHA_MAX_INSCRIPCION = data.FECHA_INSCRIPCION;
      data.FECHA_MAX_INSCRIPCION1 = data.FECHA_INSCRIPCION;
    
      data.clausulas = Array.from(document.querySelectorAll(".clausula")).map(div => ({
        titulo: div.querySelector("input[name=titulo]").value,
        texto:  div.querySelector("textarea[name=texto]").value
      })).filter(c => c.titulo || c.texto);
    
      document.getElementById("estado").textContent = "‚è≥ Generando contrato‚Ä¶";
    
      try {
        const res = await fetch("/api/generar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const fn = res.headers.get("Content-Disposition")?.match(/filename="?(.+)"?$/)?.[1] || "Contrato.docx";
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fn;
        document.body.append(a);
        a.click();
        a.remove();
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        document.getElementById("estado").textContent = "";
      }
    }
  </script>
</body>
</html>
