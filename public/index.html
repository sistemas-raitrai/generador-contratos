<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de Contratos</title>
  <link rel="stylesheet" href="/estilos.css" />
  <link rel="icon" href="/logo.png" />
</head>
<body>
  <div class="contenedor">
    <!-- Encabezado -->
    <header>
      <img src="/logo.png" alt="Logo Rai Trai">
      <div>
        <h1>GENERADOR AUTOM√ÅTICO DE CONTRATOS</h1>
        <p><strong>Giras de estudio Rai Trai</strong></p>
      </div>
    </header>

    <!-- Grupo -->
    <h2>Seleccionar Grupo</h2>
    <div class="grid">
      <label style="grid-column: span 1;">N√∫mero de Negocio:
        <input list="businessList" id="numeroNegocio" placeholder="Buscar..." />
        <datalist id="businessList"></datalist>
      </label>
      <label style="grid-column: span 2;">Nombre de Grupo:
        <input list="grupoList" id="nombreGrupo" placeholder="Buscar..." style="width:100%;" />
        <datalist id="grupoList"></datalist>
      </label>
    </div>

    <!-- Definiciones del contrato -->
    <h2>Definiciones del Contrato</h2>
    <div class="grid">
      <label style="grid-column: span 2;">Email destinatario:
        <input list="emailList" id="DEST_EMAIL" />
        <datalist id="emailList">
          <option value="nachopastorpino@gmail.com">
          <option value="griveros@raitrai.cl">
          <option value="cgayoso@raitrai.cl">
          <option value="crojas@raitrai.cl">
          <option value="orietta@raitrai.cl">
          <option value="elagos@raitrai.cl">
          <option value="aflores@raitrai.cl">
          <option value="chernandez@raitrai.cl">
        </datalist>
      </label>
      <label style="grid-column: span 1;">Moneda:
        <select id="MONEDA">
          <option value="">Selecciona moneda</option>
          <option value="$USD">$USD</option>
          <option value="$CLP">$CLP</option>
        </select>
      </label>
    </div>

    <!-- Datos del contrato -->
    <h2>Datos del Contrato</h2>
    <div class="grid">
      <label>Fecha del Contrato:<input type="date" id="FECHA_CONTRATO" /></label>
      <label>Mes del Viaje:<input type="text" id="MES_VIAJE" /></label>
      <label>Lugar de Salida:<input type="text" id="LUGAR_SALIDA" /></label>

      <label>Curso:<input type="text" id="CURSO" /></label>
      <label>Colegio:<input type="text" id="COLEGIO" /></label>
      <label>A√±o:<input type="number" id="A√ëO" /></label>

      <label>Comuna:<input type="text" id="COMUNA" /></label>
      <label>Cantidad de Pax:<input type="number" id="PAX_MIN" /></label>
      <label>Pax Liberados:<input type="text" id="PAX_LIBERADOS" /></label>

      <label>Valor del Programa:<input type="text" id="VALOR_PROGRAMA" /></label>
      <label style="grid-column: span 1;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>Cuota Inscripci√≥n:</span>
          <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; margin: 0;">
            <input type="checkbox" id="DIVIDIR_CUOTA" /> ¬ø2 pagos?
          </label>
        </div>
        <input type="text" id="CUOTA_INSCRIPCION" />
      </label>
      
      <label>D√≠a de Pago Mensual:<input type="number" id="DIA_PAGO" /></label>
      <label>Fecha Inicio de Pago:<input type="date" id="FECHA_INICIO_PAGO" /></label>
      <label>Fecha T√©rmino de Pago:<input type="date" id="FECHA_FIN_PAGO" /></label>
      

      <label>N√∫mero de Cuotas:<input type="number" id="NUM_CUOTAS" /></label>
      <label>Valor de Cuota:<input type="text" id="CUOTA_MENSUAL" /></label>
      <label>Fecha L√≠mite:<input type="date" id="FECHA_CORTE" /></label>

      <label class="oculto">Mes Inicio Pago:<input type="text" id="MES_INICIO" /></label>
      <label class="oculto">A√±o Inicio Pago:<input type="number" id="ANO_INICIO" /></label>
      <label class="oculto">Mes Fin Pago:<input type="text" id="MES_FIN" /></label>
      <label class="oculto">A√±o Fin Pago:<input type="number" id="ANO_FIN" /></label>
    </div>

    <input type="hidden" id="AUTORIZACION" />
    <input type="hidden" id="DESCUENTO" />
    <input type="hidden" id="nombreGrupo" />

    <!-- Cl√°usulas -->
    <h2>Cl√°usulas adicionales</h2>
    <div id="clausulasContainer"></div>
    <button id="addClause">‚ûï Agregar cl√°usula</button>

    <!-- Botones -->
    <div class="botones">
      <button onclick="generarContrato()">üìÑ Descargar Contrato</button>
    </div>
    <div id="estado" style="margin-top:1rem;font-style:italic;color:#c0392b;"></div>
  </div>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/AKfycbzU3RIF2TXDhlUwuSZj9VFnEienz0_XPw1mVwqzj6TWL3afs4GE-9kFkaRy9ps5YSqFaQ/exec';

    // üîÅ Carga de grupos y configuraci√≥n de autocompletado robusto
    window.addEventListener("DOMContentLoaded", () => {
      fetch(sheetURL)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(rows => {
          const bl = document.getElementById("businessList");
          const gl = document.getElementById("grupoList");
    
          // üîΩ Llenar datalist con n√∫mero de negocio y nombre de grupo
          rows.forEach(r => {
            if (r.numeroNegocio) bl.append(new Option(r.numeroNegocio, r.numeroNegocio));
            if (r.nombreGrupo)   gl.append(new Option(r.nombreGrupo,   r.nombreGrupo));
          });
    
          // üéØ Detectar cambios en ambos campos y hacer autocompletado
          ["numeroNegocio", "nombreGrupo"].forEach(id => {
            const el = document.getElementById(id);
    
            // Escucha tanto cambios directos como escritura y desenfoque (blur)
            ["change", "input", "blur"].forEach(eventType => {
              el.addEventListener(eventType, () => {
                const v = el.value.trim();
                const row = rows.find(r => String(r.numeroNegocio) === v || r.nombreGrupo === v);
                if (!row) return;
    
                // üéØ Extraer nombre del colegio, curso y a√±o (√∫ltimos)
                const partes = [...row.nombreGrupo.matchAll(/(\d+\w?)\s*\((\d{4})\)/g)];
                const ultima = partes.at(-1); // ‚úÖ Tomar la √∫ltima coincidencia
                
                if (ultima) {
                  // üè´ Extraer colegio eliminando los cursos con a√±os entre par√©ntesis
                  const nombreLimpio = row.nombreGrupo.replace(/\s*\d+\w?\s*\(\d{4}\)/g, "").replace(/\s*-\s*$/, "").trim();
                  
                  document.getElementById("COLEGIO").value = nombreLimpio;
                  document.getElementById("CURSO").value = ultima[1]; // Ej: 3B
                  document.getElementById("A√ëO").value   = ultima[2]; // Ej: 2026
                }
    
                // üì• Rellenar todos los campos con la informaci√≥n correspondiente
                document.getElementById("COMUNA").value           = row.direccion || "";
                document.getElementById("VALOR_PROGRAMA").value   = (row.valorPrograma || "").replace(/[^\d]/g, "");
                document.getElementById("PAX_MIN").value          = row.cantidadgrupo || "";
                document.getElementById("PAX_LIBERADOS").value    = row.liberados || "";
    
                // üü° Campos ocultos solo para email
                document.getElementById("AUTORIZACION").value     = row.autorizacion || "";
                document.getElementById("DESCUENTO").value        = row.descuento || "";
                document.getElementById("nombreGrupo").value      = row.nombreGrupo || "";
              });
            });
          });
        })
        .catch(err => {
          console.error("Error leyendo datos:", err);
          document.getElementById("estado").textContent = "‚ùå No se pudo cargar la base.";
        });
      
      // üî† Forzar may√∫sculas en todos los inputs de texto, textareas y selects
      document.querySelectorAll("input[type=text], input[list], textarea, select").forEach(el => {
        el.addEventListener("input", () => {
          if (el.type === "text" || el.tagName === "TEXTAREA") {
            el.value = el.value.toUpperCase();
          }
        });
      });
      
      // ‚úÖ Escucha cambios para recalcular cuotas autom√°ticamente
      ["CUOTA_INSCRIPCION", "FECHA_INICIO_PAGO", "FECHA_FIN_PAGO", "DIVIDIR_CUOTA"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", calcularCuotas);
          el.addEventListener("change", calcularCuotas);
        }
      });
    });
    // ‚úÖ Funci√≥n que calcula el n√∫mero de cuotas y el valor mensual
    function calcularCuotas() {
      console.log("üîÅ Iniciando c√°lculo de cuotas...");
    
      // üìå Funci√≥n auxiliar para limpiar montos con s√≠mbolos
      const parseMonto = val => parseFloat((val || '').replace(/[^\d.]/g, '')) || 0;
    
      // üî¢ Obtener valores desde el formulario
      const cuotaInscripcion = parseMonto(document.getElementById('CUOTA_INSCRIPCION').value);
      const valorPrograma = parseMonto(document.getElementById('VALOR_PROGRAMA').value);
      const dividir = document.getElementById('DIVIDIR_CUOTA')?.checked;
    
      const fechaInicioRaw = document.getElementById('FECHA_INICIO_PAGO').value;
      const fechaFinRaw = document.getElementById('FECHA_FIN_PAGO').value;
    
      const [anioInicio, mesInicio, diaInicio] = fechaInicioRaw.split("-").map(Number);
      const fechaInicio = new Date(anioInicio, mesInicio - 1, diaInicio);
      const [anioFin, mesFin, diaFin] = fechaFinRaw.split("-").map(Number);
      const fechaFin = new Date(anioFin, mesFin - 1, diaFin);
    
      console.log("üì¶ Datos crudos:", {
        cuotaInscripcion, valorPrograma, dividir, fechaInicio, fechaFin
      });
    
      // üö´ Validaci√≥n de datos
      if (isNaN(fechaInicio) || isNaN(fechaFin) || !cuotaInscripcion || !valorPrograma) {
        console.warn("‚ùå Datos inv√°lidos. Abortando c√°lculo.");
        return;
      }
    
      // üóìÔ∏è Clonar fechas para no alterar las originales
      const inicio = new Date(fechaInicio);
      const fin = new Date(fechaFin);
      
      // ‚úÖ Fijar hora al mediod√≠a para evitar desfasajes de mes
      inicio.setHours(12, 0, 0, 0);
      fin.setHours(12, 0, 0, 0);
    
      console.log("üìÖ D√≠a del inicio original:", inicio.getDate());
           
      // üìä Calcular cantidad total de meses de pago
      const mesesTotales = (fin.getFullYear() - inicio.getFullYear()) * 12 + (fin.getMonth() - inicio.getMonth()) + 1;
      console.log("üìÖ Meses de pago:", mesesTotales);
    
      // ‚ûó Calcular n√∫mero de cuotas reales (excluyendo inscripci√≥n)
      const cuotasReales = dividir ? mesesTotales - 2 : mesesTotales - 1;
    
      // üí∞ Calcular valor de cada cuota real
      const restante = valorPrograma - cuotaInscripcion;
      const valorMensual = cuotasReales > 0 ? (restante / cuotasReales) : 0;
    
      console.log("üî• C√°lculo final:", {
        cuotasReales, valorMensual
      });
    
      // üìù Actualizar valores en el formulario
      document.getElementById('NUM_CUOTAS').value = cuotasReales;
      document.getElementById('CUOTA_MENSUAL').value = valorMensual.toFixed(2).replace('.', ',');
    
      document.getElementById('MES_INICIO').value = inicio.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
      document.getElementById('ANO_INICIO').value = inicio.getFullYear();
      document.getElementById('MES_FIN').value = fin.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
      document.getElementById('ANO_FIN').value = fin.getFullYear();
    
      console.log("‚úÖ C√°lculo terminado y actualizado.");
    }

    // ‚úÖ Convierte fecha ISO (2025-06-24) a formato chileno (24 de junio de 2025)
    function formatearFechaChilena(fechaISO) {
      if (!fechaISO) return "";
    
      // üîç Separar manualmente los componentes para evitar errores de zona horaria
      const [anio, mes, dia] = fechaISO.split("-").map(Number);
      const fecha = new Date(anio, mes - 1, dia); // fecha local sin desfase
    
      const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
      return fecha.toLocaleDateString('es-CL', opciones);
    }
    
    // üîò Bot√≥n de generar contrato
    async function generarContrato() {
      const campos = [
        "numeroNegocio", "FECHA_CONTRATO", "CURSO", "A√ëO", "COLEGIO", "COMUNA", "VALOR_PROGRAMA",
        "PAX_MIN", "PAX_LIBERADOS", "DEST_EMAIL", "MONEDA", "CUOTA_INSCRIPCION", "FECHA_INICIO_PAGO",
        "FECHA_FIN_PAGO", "NUM_CUOTAS", "CUOTA_MENSUAL", "MES_INICIO", "ANO_INICIO",
        "MES_FIN", "ANO_FIN", "DIA_PAGO", "FECHA_CORTE",
        "MES_VIAJE", "LUGAR_SALIDA", "AUTORIZACION", "DESCUENTO", "nombreGrupo" // ‚úÖ a√±adido aqu√≠
      ];

      const data = {};
      campos.forEach(id => data[id] = document.getElementById(id)?.value || "");

      // üéØ Reemplazar fechas ISO por formato chileno
      const fechasFormateadas = ["FECHA_CONTRATO", "FECHA_INICIO_PAGO", "FECHA_FIN_PAGO", "FECHA_CORTE"];
      fechasFormateadas.forEach(key => {
        data[key] = formatearFechaChilena(data[key]);
      });

      // Alias para plantillas Word
      data.A√ëO1 = data.A√ëO;
      data.MONEDA1 = data.MONEDA;
      data.MONEDA2 = data.MONEDA;
      data.VALOR_PROGRAMA1 = data.VALOR_PROGRAMA;
      data.CUOTA_INSCRIPCION1 = data.CUOTA_INSCRIPCION;

      data.clausulas = Array.from(document.querySelectorAll(".clausula")).map(div => ({
        titulo: div.querySelector("input[name=titulo]").value,
        texto: div.querySelector("textarea[name=texto]").value
      })).filter(c => c.titulo || c.texto);

      document.getElementById("estado").textContent = "‚è≥ Generando contrato‚Ä¶";

      try {
       // ‚úÖ Reemplazar comas por puntos en montos num√©ricos antes de enviar
        ["CUOTA_MENSUAL", "CUOTA_INSCRIPCION", "VALOR_PROGRAMA"].forEach(key => {
          if (data[key]) data[key] = data[key].replace(",", ".");
        });
        
        const res = await fetch("/api/generar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(await res.text());

        const blob = await res.blob();
        const fn = res.headers.get("Content-Disposition")?.match(/filename="?(.+?)"?$/)?.[1] || "Contrato.docx";
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fn;
        a.click();
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      } finally {
        document.getElementById("estado").textContent = "";
      }
    }
  </script>
</body>
</html>
